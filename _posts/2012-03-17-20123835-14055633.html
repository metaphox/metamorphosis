---
title: 为什么 i=3; s=(++i)+(++i)+(++i); s==? 的结果在 JavaScript 和 C++ 中计算的结果是不一致的？
layout: post
---
补充解释一下为什么不同的 C / C++ 编译器<b>可以</b>有不同表现：<ol><li>C / C++ 标准中都规定[1][2]有 sequence point ：<blockquote>At certain specified points in the execution sequence called <i>sequence points</i>, all side effects of previous evaluations shall be complete and no <i>side effects</i> of subsequent evaluations shall have taken place.</blockquote></li><li>所谓 side effects 即对于执行环境的状态有所影响，比如改变变量的值。</li><li>Prefix increment 运算符 ++E 实际上等同于 (E+=1) [3]，换言之，它会改变 E 的值。</li><li>Compound assignment E1 <i>op</i>= E2 几乎等同于 E1 = E1 <i>op</i> (E2) ，唯一区别是 E1 只会计算一次[4]。</li><li>C / C++ 标准对于执行构成某表达式之子表达式的次序并<b>无指定</b>（<b><i>unspecified</i></b>[5]，而非 undefined，两者并不相同[6]。下述 9 是 undefined 的状况）。</li><li>换言之，型如 (++x) + (++y) [...] 这样的表达式中，括号圈起的表达式的执行次序可以由编译器自行决定。</li><li>在两个 sequence point 之间，一个对象（object）所储存的值最多只应通过执行一个表达式来改变一次，并且只应在需要决定储存何值的情况下访问这一结果[6]：<blockquote>Between the previous and next sequence point an object shall have its stored value modified at most once by the evaluation of an expression. Furthermore, the prior value shall be read only to determine the value to be stored.</blockquote></li><li>(++i) + (++i); 这样的表达式中，i 的值改变两次，违反了上述引文的第一句；而由 6 可知，两次 ++i 的执行次序并无指定，但无论哪一个 ++i 先执行，与另一个 ++i 相加时将读取其结果，但此结果已经不再会决定 i 将会存储何值，违反了上述引文的第二句。</li><li>违反 7 中引文的规定属于 undefined[7]，这一情况并无标准规定应对措施，可以由<b>编译器自由处置</b>[9]，可能的结果包括（但不限于）忽略结果、中止程序运行、复活僵尸恐龙、导致女友怀孕、发射洲际飞弹、引发天网觉醒、或者删除硬盘上一切视频文件。</li></ol><br>Sequence point 是这个问题（以及很多其他 C / C++ 问题）难以理解的主要原因。但很多教材也有意或无意地绕开 / 简化描述 sequence point 的原理，只是粗暴地教导读者不应该这样做。<br><br>Sequence point 的存在，是 C 语言以编译器书写者之便利为主要设计宗旨的一种体现。诸如 Java / JavaScript 等其他绝大多数编程语言并无 sequence point 的概念，比如 Java 明确规定了表达式的计算次序[10]，ECMA Script 情况类似[11]，所以没有太多编译（解释）器行为不一致的问题。<br><br>[1] ISO/IEC 9899:1999 (C99), §5.1.2.3 – 3<br>[2] ISO/IEC 14882:2011 (C++11), §1.9 – 7<br>[3] C99, §6.5.3.1 – 2<br>[4] C99, §6.5.16.2 – 3<br>[5] C99, Annex J.1<br>[6] <a href="https://link.zhihu.com/?target=http%3A//stackoverflow.com/questions/2397984/undefined-unspecified-and-implementation-defined-behavior" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">http://</span><span class="visible">stackoverflow.com/quest</span><span class="invisible">ions/2397984/undefined-unspecified-and-implementation-defined-behavior</span><span class="ellipsis"></span><i class="icon-external"></i></a><br>[7] C99, §6.5 - 2<br>[8] C99, Annex J.2<br>[9] C99, §3.4.3 - 2<br>[10] <a href="https://link.zhihu.com/?target=http%3A//docs.oracle.com/javase/specs/jls/se7/html/jls-15.html%23jls-15.7" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">http://</span><span class="visible">docs.oracle.com/javase/</span><span class="invisible">specs/jls/se7/html/jls-15.html#jls-15.7</span><span class="ellipsis"></span><i class="icon-external"></i></a><br>[11] ECMA 262, Annex D <a href="https://link.zhihu.com/?target=http%3A//www.ecma-international.org/publications/files/ECMA-ST/Ecma-262.pdf" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">http://www.</span><span class="visible">ecma-international.org/</span><span class="invisible">publications/files/ECMA-ST/Ecma-262.pdf</span><span class="ellipsis"></span><i class="icon-external"></i></a>
<hr>
原发布于 <a href="https://www.zhihu.com/question/20123835/answer/14055633">https://www.zhihu.com/question/20123835/answer/14055633</a></p>